<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pricelist Topup</title>
  <meta name="description" content="Pricelist interaktif terhubung Google Sheets (multi-game).">
  <style>
    :root{
      --bg:#ffffff; --text:#0b0e12; --muted:#667085; --surface:#f7f8fa; --border:#e5e7eb;
      --primary:#0f172a; --maxw:1100px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0e12; --text:#e5e7eb; --muted:#9aa4b2; --surface:#0f1318; --border:#1f2730; --primary:#e5e7eb; }
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font:16px/1.55 ui-sans-serif,-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:24px}
    header h1{margin:0 0 4px;font-size:clamp(20px,2.4vw,28px)}
    header p{margin:0;color:var(--muted);font-size:14px}

    .tabs{display:flex;gap:10px;margin:18px 0 12px;flex-wrap:wrap}
    .tab{padding:10px 14px;border:1px solid var(--border);background:var(--surface);
      border-radius:10px;cursor:pointer;user-select:none;font-weight:600;font-size:14px}
    .tab[aria-selected="true"]{outline:2px solid var(--primary)}

    .tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .tools input[type="search"]{flex:1 1 260px;padding:10px 12px;border:1px solid var(--border);
      background:var(--surface);color:var(--text);border-radius:10px;font-size:14px}
    .tools .info{color:var(--muted);font-size:13px}

    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .card{border:1px solid var(--border);background:var(--surface);border-radius:12px;padding:14px;
      display:flex;flex-direction:column;gap:8px}
    .card h3{margin:0;font-size:16px}
    .card p{margin:0;color:var(--muted);font-size:13px}
    .price{font-weight:800;font-size:18px;margin-top:2px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .btn{margin-top:auto;display:inline-block;text-align:center;text-decoration:none;
      padding:10px 12px;border-radius:10px;background:var(--primary);color:#fff;font-weight:700;font-size:14px}
    @media (prefers-color-scheme: dark){ .btn{color:#0b0e12;background:#e5e7eb} }
    .empty{border:1px dashed var(--border);border-radius:12px;padding:20px;text-align:center;color:var(--muted);font-size:14px}
    .err{border:1px solid #b91c1c;background:#fef2f2;color:#7f1d1d;border-radius:12px;padding:14px;display:none}
    @media (prefers-color-scheme: dark){ .err{background:#1a0b0b;color:#fca5a5;border-color:#7f1d1d} }
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <h1>Pricelist Topup</h1>
      <p>Pilih game, cari paket, lalu klik untuk order via WhatsApp.</p>
    </header>

    <nav id="tabs" class="tabs" role="tablist" aria-label="Game"></nav>

    <div class="tools">
      <input id="search" type="search" placeholder="Cari paket atau kodeâ€¦" aria-label="Cari">
      <span id="countInfo" class="info"></span>
    </div>

    <section id="grid" class="grid" aria-live="polite"></section>
    <section id="error" class="err"></section>

    <template id="cardTmpl">
      <article class="card">
        <h3 class="title"></h3>
        <p class="desc"></p>
        <div class="meta">
          <span class="kode"></span>
        </div>
        <div class="price"></div>
        <a class="btn" target="_blank" rel="noopener">Order</a>
      </article>
    </template>
  </main>

  <script>
    // ========= KONFIG =========
    const SHEET_ID   = '1B0XPR4uSvRzy9LfzWDjNjwAyMZVtJs6_Kk_r2fh7dTw'; // <- punyamu
    const SHEET_NAME = 'Sheet3'; // ganti kalau tabnya bukan Sheet3
    const SHEET_JSON_URL =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;

    // WhatsApp tujuan
    const WA_NUMBER   = '6285877001999';
    const WA_GREETING = 'Halo, saya mau order:';

    // ========= UTIL =========
    function prettyLabel(raw){
      const s = String(raw||'').trim();
      return s.replace(/\s+/g,' ');
    }
    function makeKode(catKey, title){
      // contoh: cat "Mobile Legend IDN" + "86 Diamonds" -> "mobile-legend-idn86"
      const num = (String(title).match(/\d+/) || [''])[0];
      const base = (catKey||'game').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
      return `${base}${num?num:''}`;
    }
    const toIDR = v => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(v);

    // Elemen
    const tabsEl      = document.getElementById('tabs');
    const gridEl      = document.getElementById('grid');
    const searchEl    = document.getElementById('search');
    const countInfoEl = document.getElementById('countInfo');
    const cardTmpl    = document.getElementById('cardTmpl');
    const errBox      = document.getElementById('error');

    // State
    let DATA = [];  // {catKey, catLabel, title, price, kode}
    let CATS = [];  // [{key,label}]
    let activeCat = '';
    let query = '';

    // ========= PARSER GViz STABIL =========
    function parseGVizPairs(jsonText){
      // Ambil objek JSON di dalam setResponse(...{...}...)
      const m = jsonText.match(/\{.*\}/s);
      if(!m) throw new Error('Response GViz tidak valid (tidak ditemukan objek JSON).');
      const obj = JSON.parse(m[0]);

      const table = obj.table || {};
      const rows  = table.rows || [];
      const cols  = table.cols || [];

      // Pasangan kolom: [A,B] [C,D] [E,F] ... = [Nama, Harga]
      const pairs = [];
      for(let i=0;i<cols.length;i+=2){
        const label = cols[i]?.label || '';
        if(!label || !cols[i+1]) continue;
        pairs.push({ iTitle:i, iPrice:i+1, label });
      }

      const out = [];
      for(const r of rows){
        const c = r.c || [];
        for(const p of pairs){
          const title = c[p.iTitle]?.v != null ? String(c[p.iTitle].v).trim() : '';
          const priceRaw = c[p.iPrice]?.v;
          const price = priceRaw!=null && priceRaw!=='' ? Number(priceRaw) : NaN;
          if(title && !Number.isNaN(price)){
            out.push({
              catKey: p.label,
              catLabel: prettyLabel(p.label),
              title,
              price,
              kode: makeKode(p.label, title)
            });
          }
        }
      }
      return out;
    }

    function buildTabs(){
      const map = new Map();
      for(const it of DATA){ if(!map.has(it.catKey)) map.set(it.catKey, it.catLabel); }
      CATS = [...map].map(([key,label]) => ({key,label}));

      tabsEl.innerHTML = '';
      CATS.forEach((c, idx)=>{
        const b = document.createElement('button');
        b.className = 'tab';
        b.type = 'button';
        b.setAttribute('role','tab');
        b.setAttribute('aria-selected', idx===0 ? 'true' : 'false');
        b.dataset.cat = c.key;
        b.textContent = c.label;
        b.addEventListener('click', ()=>{
          [...tabsEl.children].forEach(x=>x.setAttribute('aria-selected','false'));
          b.setAttribute('aria-selected','true');
          activeCat = c.key;
          renderGrid();
        });
        b.addEventListener('keydown', e=>{
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); b.click(); }
        });
        tabsEl.appendChild(b);
      });
      activeCat = CATS[0]?.key || '';
    }

    function renderGrid(){
      const items = DATA
        .filter(x => x.catKey===activeCat)
        .filter(x => {
          if(!query) return true;
          const q = query.toLowerCase();
          return x.title.toLowerCase().includes(q) ||
                 x.kode.toLowerCase().includes(q) ||
                 String(x.price).includes(q);
        });

      gridEl.innerHTML = '';
      if(items.length===0){
        const d = document.createElement('div');
        d.className = 'empty';
        d.textContent = 'Tidak ada hasil. Ubah kata kunci atau pilih kategori lain.';
        gridEl.appendChild(d);
        countInfoEl.textContent = '';
        return;
      }

      for(const it of items){
        const $ = cardTmpl.content.cloneNode(true);
        $.querySelector('.title').textContent = it.title;
        $.querySelector('.desc').textContent  = '';
        $.querySelector('.kode').textContent  = `Kode: ${it.kode}`;
        $.querySelector('.price').textContent = toIDR(it.price);

        const a = $.querySelector('.btn');
        const text = `${WA_GREETING}\n- Game: ${it.catLabel}\n- Item: ${it.title}\n- Kode: ${it.kode}\n- Harga: ${toIDR(it.price)}`;
        a.href = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)}`;
        a.textContent = 'Order';

        gridEl.appendChild($);
      }
      countInfoEl.textContent = `${items.length} item`;
    }

    // Search (debounce)
    let to=null;
    searchEl.addEventListener('input', e=>{
      clearTimeout(to);
      to=setTimeout(()=>{ query = e.target.value.trim(); renderGrid(); }, 120);
    });

    // ========= LOAD =========
    async function load(){
      try{
        const res = await fetch(SHEET_JSON_URL, {cache:'no-store'});
        const txt = await res.text();
        DATA = parseGVizPairs(txt);
        if(DATA.length===0) throw new Error('Data kosong atau format kolom tidak sesuai (A/B, C/D, dst).');

        buildTabs();
        renderGrid();
      }catch(err){
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = `Gagal memuat data: ${err.message}`;
      }
    }

    load();
  </script>
</body>
</html>
