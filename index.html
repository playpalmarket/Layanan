<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pricelist Topup</title>
  <meta name="description" content="Pricelist interaktif terhubung Google Sheets (multi-game).">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #ffffff; --text: #1f2937; --muted: #6b7280; 
      --surface: #f3f3f3; --border: #e5e7eb; --surface-hover: #e9e9e9;
      --primary: #5C80BC; --primary-hover: #4a6b9a;
      --maxw: 1100px; --radius: 8px;
    }
    @media (prefers-color-scheme: dark){
      :root{ 
        --bg: #111827; --text: #f3f4f6; --muted: #9ca3af; 
        --surface: #1f2937; --border: #374151; --surface-hover: #374151;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: 'Inter', ui-sans-serif, -apple-system, system-ui, "Segoe UI", sans-serif;
      font-size: 15px; line-height: 1.5;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .wrap{max-width:var(--maxw); margin:0 auto; padding: 32px 16px}
    header h1{margin:0 0 4px; font-size:clamp(22px, 3vw, 28px); font-weight:700;}
    header p{margin:0; color:var(--muted); font-size:15px;}

    .tabs{display:flex; gap:10px; margin:20px 0 16px; flex-wrap:wrap; padding-bottom: 4px; overflow-x: auto;}
    .tab{
      padding:6px 14px; border:1px solid var(--border); background:var(--bg); color:var(--muted);
      border-radius:var(--radius); cursor:pointer; user-select:none;
      font-weight:600; font-size:14px; transition: all 0.2s ease; white-space: nowrap;
    }
    .tab:hover{ background:var(--surface); color:var(--text); }
    .tab[aria-selected="true"]{ background:var(--primary); color:#fff; border-color:var(--primary); }

    .tools{display:flex; flex-wrap:wrap; align-items:center; margin-bottom:16px}
    .search-wrap{position:relative; flex:1 1 250px;}
    .search-wrap svg{ position:absolute; left:12px; top:50%; transform:translateY(-50%); width:18px; height:18px; color:var(--muted); }
    .tools input[type="search"]{
      width:100%; padding:8px 12px 8px 38px; border:1px solid var(--border);
      background:var(--bg); color:var(--text); border-radius:var(--radius); font-size:14px;
      transition: border-color 0.2s ease;
    }
    .tools input[type="search"]:focus{ outline:none; border-color:var(--primary); }
    .tools .info{color:var(--muted); font-size:13px; font-weight:500; padding-left: 12px;}

    /* [DIUBAH] Mengganti Grid menjadi layout list/daftar */
    .list-container{
      display:flex;
      flex-direction: column;
      gap: 8px; /* Jarak antar baris */
    }
    .list-item{
      display:flex;
      justify-content: space-between; /* Mendorong nama & harga ke ujung */
      align-items: center;
      padding: 12px 16px;
      background: var(--surface);
      border-radius: var(--radius);
      text-decoration: none;
      color: inherit;
      transition: background-color 0.2s ease;
    }
    .list-item:hover{
      background-color: var(--surface-hover);
    }
    .list-item .title{
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }
    .list-item .price{
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .empty, .err{
      border:1px dashed var(--border); border-radius:var(--radius); padding:40px; text-align:center; 
      color:var(--muted); font-size:14px;
    }
    .err{ border:1px solid #ef4444; background:#fef2f2; color:#b91c1c; display:none }
    @media (prefers-color-scheme: dark){ .err{background:#2a0c0c; color:#fca5a5; border-color:#7f1d1d} }
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <h1>Pricelist Topup</h1>
      <p>Pilih game, cari paket, lalu klik untuk order via WhatsApp.</p>
    </header>

    <nav id="tabs" class="tabs" role="tablist" aria-label="Game"></nav>

    <div class="tools">
      <div class="search-wrap">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
        <input id="search" type="search" placeholder="Cari item..." aria-label="Cari">
      </div>
      <span id="countInfo" class="info"></span>
    </div>

    <section id="list-container" class="list-container" aria-live="polite"></section>
    <section id="error" class="err"></section>

    <template id="itemTmpl">
      <a class="list-item" target="_blank" rel="noopener">
        <span class="title"></span>
        <span class="price"></span>
      </a>
    </template>
  </main>

  <script>
    // ========= KONFIG =========
    const SHEET_ID   = '1B0XPR4uSvRzy9LfzWDjNjwAyMZVtJs6_Kk_r2fh7dTw';
    const SHEET_NAME = 'Sheet3';
    const SHEET_JSON_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;
    const WA_NUMBER   = '6285877001999';
    const WA_GREETING = 'Halo, saya mau order:';

    // ========= ELEMEN & STATE (DIUBAH sedikit) =========
    const tabsEl = document.getElementById('tabs');
    const listEl = document.getElementById('list-container'); // Menggunakan ID baru
    const searchEl = document.getElementById('search');
    const countInfoEl = document.getElementById('countInfo');
    const itemTmpl = document.getElementById('itemTmpl'); // Menggunakan ID baru
    const errBox = document.getElementById('error');
    
    let DATA = [], CATS = [], activeCat = '', query = '';

    // ========= UTIL & PARSER (tidak ada perubahan) =========
    function prettyLabel(raw){ return String(raw||'').trim().replace(/\s+/g,' '); }
    function makeKode(catKey, title){
      const num = (String(title).match(/\d+/) || [''])[0];
      const base = (catKey||'game').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
      return `${base}${num?num:''}`;
    }
    const toIDR = v => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(v);

    function parseGVizPairs(jsonText){
      const m = jsonText.match(/\{.*\}/s);
      if(!m) throw new Error('Response GViz tidak valid.');
      const obj = JSON.parse(m[0]);
      const table = obj.table || {}, rows  = table.rows || [], cols = table.cols || [];
      const pairs = [];
      for(let i=0; i<cols.length; i+=2){
        const label = cols[i]?.label || '';
        if(label && cols[i+1]) pairs.push({ iTitle:i, iPrice:i+1, label });
      }
      const out = [];
      for(const r of rows){
        const c = r.c || [];
        for(const p of pairs){
          const title = c[p.iTitle]?.v != null ? String(c[p.iTitle].v).trim() : '';
          const priceRaw = c[p.iPrice]?.v;
          const price = priceRaw!=null && priceRaw!=='' ? Number(priceRaw) : NaN;
          if(title && !isNaN(price)){
            out.push({
              catKey: p.label, catLabel: prettyLabel(p.label),
              title, price, kode: makeKode(p.label, title)
            });
          }
        }
      }
      return out;
    }
    
    // ========= RENDER LOGIC (DIUBAH sedikit) =========
    function buildTabs(){
      const map = new Map();
      DATA.forEach(it => { if(!map.has(it.catKey)) map.set(it.catKey, it.catLabel) });
      CATS = [...map].map(([key,label]) => ({key,label}));
      tabsEl.innerHTML = '';
      CATS.forEach((c, idx)=>{
        const b = document.createElement('button');
        b.className = 'tab'; b.type = 'button'; b.role = 'tab';
        b.setAttribute('aria-selected', idx === 0 ? 'true' : 'false');
        b.dataset.cat = c.key; b.textContent = c.label;
        b.onclick = () => {
          tabsEl.querySelector('[aria-selected="true"]').setAttribute('aria-selected', 'false');
          b.setAttribute('aria-selected', 'true');
          activeCat = c.key;
          renderList();
        };
        tabsEl.appendChild(b);
      });
      activeCat = CATS[0]?.key || '';
    }

    function renderList(){
      const items = DATA.filter(x => x.catKey === activeCat && 
        (query === '' || x.title.toLowerCase().includes(query) || String(x.price).includes(query))
      );

      listEl.innerHTML = ''; // Mengosongkan list container
      if(items.length === 0){
        listEl.innerHTML = `<div class="empty">Tidak ada hasil ditemukan.</div>`;
        countInfoEl.textContent = '';
        return;
      }
      
      const fragment = document.createDocumentFragment();
      for(const it of items){
        const clone = itemTmpl.content.cloneNode(true);
        const link = clone.querySelector('.list-item');
        link.querySelector('.title').textContent = it.title;
        link.querySelector('.price').textContent = toIDR(it.price);
        
        const text = `${WA_GREETING}\n- Game: ${it.catLabel}\n- Item: ${it.title}\n- Harga: ${toIDR(it.price)}`;
        link.href = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)}`;
        fragment.appendChild(clone);
      }
      listEl.appendChild(fragment); // Menambahkan item ke list container
      countInfoEl.textContent = `${items.length} item`;
    }

    // ========= EVENT LISTENERS & LOAD (DIUBAH sedikit) =========
    let debounceTimer;
    searchEl.addEventListener('input', e => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        query = e.target.value.trim().toLowerCase();
        renderList();
      }, 150);
    });

    async function load(){
      try{
        const res = await fetch(SHEET_JSON_URL, {cache:'no-store'});
        const txt = await res.text();
        DATA = parseGVizPairs(txt);
        if(DATA.length === 0) throw new Error('Data kosong atau format kolom tidak sesuai.');
        buildTabs();
        renderList();
      }catch(err){
        errBox.style.display = 'block';
        errBox.textContent = `Gagal memuat data: ${err.message}`;
      }
    }
    load();
  </script>
</body>
</html>
